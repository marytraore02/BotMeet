<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet Recorder Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modern-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .input-modern {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .input-modern:focus {
            border: 2px solid #667eea;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .btn-gradient:disabled {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            transform: none;
            box-shadow: none;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-stop:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }
        
        .floating-orb {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .floating-orb:nth-child(1) {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .floating-orb:nth-child(2) {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #764ba2, #667eea);
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .floating-orb:nth-child(3) {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .timer-glow {
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse-glow {
            from { text-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
            to { text-shadow: 0 0 30px rgba(102, 126, 234, 0.8), 0 0 40px rgba(102, 126, 234, 0.3); }
        }
        
        #status-container::-webkit-scrollbar { width: 8px; }
        #status-container::-webkit-scrollbar-track { 
            background: rgba(241, 245, 249, 0.5); 
            border-radius: 10px;
        }
        #status-container::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        .status-modern {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .recording-pulse {
            animation: recordingPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes recordingPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 relative">
    <!-- Orbes flottantes en arrière-plan -->
    <div class="floating-orb"></div>
    <div class="floating-orb"></div>
    <div class="floating-orb"></div>

    <div class="w-full max-w-4xl modern-card rounded-3xl shadow-2xl p-8 space-y-8 relative z-10 slide-in mx-auto">
        <!-- En-tête avec design moderne -->
        <div class="text-center space-y-4">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full glass-effect mb-4">
                <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold gradient-text">Meet Recorder Bot</h1>
            <div class="glass-effect rounded-2xl p-4 inline-block">
                <p class="text-slate-700 font-medium">Assurez-vous d'avoir une bonne connexion internet</p>
            </div>
            <p class="text-slate-600 text-lg">Lancez et arrêtez un enregistrement audio de vos réunions avec style.</p>
        </div>

        <!-- Formulaire avec design moderne -->
        <form id="control-form" class="space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Lien de la réunion -->
                <div class="space-y-2">
                    <label for="meet-link" class="block text-sm font-semibold text-slate-700 mb-3">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            <span>Lien de la réunion Meet</span>
                        </div>
                    </label>
                    <input type="url" id="meet-link" name="meet-link" required
                           class="input-modern block w-full px-6 py-4 rounded-2xl shadow-lg placeholder-slate-400 focus:outline-none font-medium"
                           placeholder="https://meet.google.com/xxx-yyyy-zzz">
                </div>

                <!-- Durée -->
                <div class="space-y-2">
                    <label for="duration" class="block text-sm font-semibold text-slate-700 mb-3">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Durée de l'enregistrement</span>
                        </div>
                    </label>
                    <div class="flex space-x-3">
                        <input type="number" id="duration" name="duration" required min="1" step="1" value="30"
                               class="input-modern block w-2/3 px-6 py-4 rounded-2xl shadow-lg placeholder-slate-400 focus:outline-none font-medium">
                        <select id="duration-unit" class="input-modern block w-1/3 px-6 py-4 rounded-2xl shadow-lg focus:outline-none font-medium">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Heures</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Boutons modernes -->
            <div class="flex space-x-4 pt-4">
                <button type="submit" id="start-btn"
                        class="btn-gradient w-full flex justify-center items-center py-4 px-6 rounded-2xl text-lg font-bold text-white focus:outline-none focus:ring-4 focus:ring-purple-300 disabled:cursor-not-allowed">
                    <svg id="spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="start-button-text">🚀 Lancer l'enregistrement</span>
                </button>
                <button type="button" id="stop-btn"
                        class="btn-stop w-full flex justify-center items-center py-4 px-6 rounded-2xl text-lg font-bold text-white focus:outline-none focus:ring-4 focus:ring-red-300 disabled:cursor-not-allowed hidden">
                    🛑 Arrêter le processus
                </button>
            </div>
        </form>

        <!-- Section Statut moderne -->
        <div id="status-section" class="hidden space-y-6 slide-in">
            <!-- Timer moderne -->
            <div id="timer-container" class="hidden">
                <div class="glass-effect rounded-3xl p-8 text-center recording-pulse">
                    <div class="flex items-center justify-center space-x-3 mb-4">
                        <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse"></div>
                        <p class="text-lg font-bold text-slate-700">ENREGISTREMENT EN COURS</p>
                        <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse"></div>
                    </div>
                    <p class="text-sm font-medium text-slate-500 mb-2">Temps restant</p>
                    <p id="timer" class="text-6xl font-black gradient-text timer-glow tracking-wider">00:00:00</p>
                </div>
            </div>

            <!-- Journal des événements moderne -->
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="text-2xl font-bold gradient-text">Journal des événements</h2>
                </div>
                <div id="status-container" class="status-modern w-full h-48 p-6 overflow-y-auto text-sm font-mono space-y-3 rounded-3xl border border-white/30"></div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('control-form');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const spinner = document.getElementById('spinner');
        const startButtonText = document.getElementById('start-button-text');
        const statusSection = document.getElementById('status-section');
        const statusContainer = document.getElementById('status-container');
        const meetLinkInput = document.getElementById('meet-link');
        const durationInput = document.getElementById('duration');
        const durationUnitInput = document.getElementById('duration-unit');
        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer');

        let timerInterval = null;

        const ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port || 3000}`);

        ws.onopen = () => addStatusMessage('🔌 Connecté au serveur.', 'system');
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            // **CORRECTION** : La logique de gestion des messages est améliorée.
            switch (data.type) {
                case 'recording_started':
                    addStatusMessage(data.message, 'status');
                    timerContainer.classList.remove('hidden');
                    startTimer(data.duration);
                    break;
                case 'finished': // Seul le message 'finished' réinitialise l'interface.
                    addStatusMessage(data.message, data.type);
                    setUiState('idle');
                    break;
                case 'error': // Une erreur intermédiaire affiche juste le message sans changer l'état de l'UI.
                    addStatusMessage(data.message, data.type);
                    break;
                default:
                    addStatusMessage(data.message, data.type);
            }
        };

        ws.onclose = () => {
            addStatusMessage('🔌 Déconnecté du serveur. Veuillez rafraîchir la page.', 'error');
            setUiState('disconnected');
        };
        ws.onerror = () => addStatusMessage('❌ Erreur de connexion au serveur.', 'error');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const durationValue = parseFloat(durationInput.value);
            const durationUnit = durationUnitInput.value;
            let durationInHours = durationUnit === 'hours' ? durationValue : durationValue / 60;
            
            setUiState('running');
            clearStatus();
            statusSection.classList.remove('hidden');

            try {
                const response = await fetch('/start-recording', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ meetLink: meetLinkInput.value, durationInHours }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Une erreur est survenue.');
                addStatusMessage('✅ Requête de démarrage envoyée. Connexion en cours...', 'success');
            } catch (error) {
                addStatusMessage(`❌ Erreur: ${error.message}`, 'error');
                setUiState('idle');
            }
        });

        stopBtn.addEventListener('click', async () => {
            stopBtn.disabled = true;
            addStatusMessage('Envoi de la demande d\'arrêt...', 'warning');
            try {
                await fetch('/stop-recording', { method: 'POST' });
            } catch (error) {
                addStatusMessage(`❌ Erreur lors de la demande d'arrêt: ${error.message}`, 'error');
                stopBtn.disabled = false;
            }
        });

        function setUiState(state) {
            clearInterval(timerInterval);

            if (state === 'running') {
                startBtn.disabled = true;
                spinner.classList.remove('hidden');
                startButtonText.textContent = '⏳ En cours...';
                stopBtn.classList.remove('hidden');
                stopBtn.disabled = false;
                meetLinkInput.disabled = true;
                durationInput.disabled = true;
                durationUnitInput.disabled = true;
                timerContainer.classList.add('hidden');
            } else if (state === 'idle') {
                startBtn.disabled = false;
                spinner.classList.add('hidden');
                startButtonText.textContent = '🚀 Lancer l\'enregistrement';
                stopBtn.classList.add('hidden');
                stopBtn.disabled = true;
                meetLinkInput.disabled = false;
                durationInput.disabled = false;
                durationUnitInput.disabled = false;
                timerContainer.classList.add('hidden');
            } else if (state === 'disconnected') {
                startBtn.disabled = true;
                stopBtn.disabled = true;
                meetLinkInput.disabled = true;
                durationInput.disabled = true;
                durationUnitInput.disabled = true;
                timerContainer.classList.add('hidden');
            }
        }

        function startTimer(duration) {
            let timer = Math.round(duration);
            const updateDisplay = () => {
                let hours = Math.floor(timer / 3600);
                let minutes = Math.floor((timer % 3600) / 60);
                let seconds = timer % 60;
                hours = String(hours).padStart(2, '0');
                minutes = String(minutes).padStart(2, '0');
                seconds = String(seconds).padStart(2, '0');
                timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            };
            
            updateDisplay();
            timerInterval = setInterval(() => {
                timer--;
                updateDisplay();
                if (timer < 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function clearStatus() { statusContainer.innerHTML = ''; }
        function addStatusMessage(message, type = 'status') {
            const p = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            let colorClass = 'text-slate-600', emoji = 'ℹ️';
            switch (type) {
                case 'success': case 'finished': colorClass = 'text-green-600'; emoji = type === 'finished' ? '🎉' : '✅'; break;
                case 'error': colorClass = 'text-red-600 font-semibold'; emoji = '❌'; break;
                case 'warning': colorClass = 'text-amber-600'; emoji = '⚠️'; break;
                case 'system': colorClass = 'text-indigo-600'; emoji = '🔌'; break;
                case 'status':
                default:
                   if (message.includes('🔴')) {
                       colorClass = 'text-red-500 font-semibold';
                   }
                   break;
            }
            p.className = `break-words ${colorClass} p-3 rounded-xl bg-white/50 backdrop-blur-sm border border-white/30 slide-in`;
            p.innerHTML = `<span class="font-semibold mr-2">[${time}]</span> ${emoji} ${message}`;
            statusContainer.appendChild(p);
            statusContainer.scrollTop = statusContainer.scrollHeight;
        }
    </script>
</body>
</html>